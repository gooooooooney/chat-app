# ç¬¬äºŒæ­¥éªŒè¯ï¼šèŠå¤©åˆ—è¡¨æ˜¾ç¤º"[å›¾ç‰‡]"æ–‡å­—

## âœ… éªŒè¯å®Œæˆ

### å®ç°åˆ†æ

**åç«¯å®ç° (`packages/backend/convex/v1/messages.ts:219-223`)**
```typescript
const messagePreview = type === "text"
  ? content.trim()
  : type === "image"
    ? "[å›¾ç‰‡]"      // âœ… å›¾ç‰‡æ¶ˆæ¯æ˜¾ç¤º"[å›¾ç‰‡]"
    : "[æ–‡ä»¶]";

await ctx.db.patch(conversationId, {
  lastMessageAt: now,
  lastMessagePreview: messagePreview,  // âœ… ä¿å­˜åˆ°conversation
  updatedAt: now,
});
```

**å‰ç«¯æ•°æ®æµ**
```
conversation.lastMessagePreview ("[å›¾ç‰‡]")
  â†“
useChatData.ts (line 50)
  â†“
chatData.lastMessage
  â†“
ChatListItem.tsx (line 73)
  â†“
æ˜¾ç¤ºï¼š[å›¾ç‰‡]
```

**å…³é”®ä»£ç è·¯å¾„ï¼š**

1. **åç«¯è®¾ç½®é¢„è§ˆ** (`messages.ts:219-223`)
   ```typescript
   type === "image" ? "[å›¾ç‰‡]" : ...
   ```

2. **å‰ç«¯è·å–æ•°æ®** (`useChatData.ts:50`)
   ```typescript
   lastMessage: conversation.lastMessagePreview || "æš‚æ— æ¶ˆæ¯"
   ```

3. **å‰ç«¯æ˜¾ç¤º** (`ChatListItem.tsx:73`)
   ```tsx
   <Text numberOfLines={1}>
     {item.lastMessage}  {/* æ˜¾ç¤º "[å›¾ç‰‡]" */}
   </Text>
   ```

### æµ‹è¯•éªŒè¯

**æµ‹è¯•æ­¥éª¤ï¼š**
1. å‘é€ä¸€æ¡å›¾ç‰‡æ¶ˆæ¯
2. è¿”å›èŠå¤©åˆ—è¡¨
3. æ£€æŸ¥è¯¥ä¼šè¯çš„æœ€åæ¶ˆæ¯

**é¢„æœŸç»“æœï¼š**
```
ä¼šè¯åˆ—è¡¨æ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¤´åƒ]  ç”¨æˆ·å          12:30  â”‚
â”‚         [å›¾ç‰‡]              (1) â”‚  â† æ˜¾ç¤º"[å›¾ç‰‡]"æ–‡å­—ï¼Œä¸æ˜¯å®é™…å›¾ç‰‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…æ•°æ®ç¤ºä¾‹ï¼š**
```json
{
  "conversation": {
    "_id": "xxx",
    "lastMessagePreview": "[å›¾ç‰‡]",  // âœ… åç«¯è¿”å›çš„é¢„è§ˆæ–‡æœ¬
    "lastMessageAt": 1759318286881
  }
}
```

### æ¶ˆæ¯ç±»å‹é¢„è§ˆæ˜ å°„

| æ¶ˆæ¯ç±»å‹ | `type` å€¼ | é¢„è§ˆæ–‡æœ¬ | å®é™…å†…å®¹ |
|---------|----------|---------|---------|
| æ–‡æœ¬ | `"text"` | æ¶ˆæ¯å†…å®¹ | "ä½ å¥½" â†’ æ˜¾ç¤º "ä½ å¥½" |
| å›¾ç‰‡ | `"image"` | `"[å›¾ç‰‡]"` | imageUrl â†’ æ˜¾ç¤º "[å›¾ç‰‡]" |
| æ–‡ä»¶ | `"file"` | `"[æ–‡ä»¶]"` | fileUrl â†’ æ˜¾ç¤º "[æ–‡ä»¶]" |
| ç³»ç»Ÿ | `"system"` | æ¶ˆæ¯å†…å®¹ | "ç”¨æˆ·åŠ å…¥" â†’ æ˜¾ç¤º "ç”¨æˆ·åŠ å…¥" |

### ä»£ç ç¡®è®¤æ¸…å•

- [x] åç«¯ `sendMessage` æ­£ç¡®è®¾ç½® `lastMessagePreview`
- [x] å›¾ç‰‡æ¶ˆæ¯é¢„è§ˆä¸º `"[å›¾ç‰‡]"`
- [x] `useChatData` æ­£ç¡®æ˜ å°„ `lastMessagePreview` â†’ `lastMessage`
- [x] `ChatListItem` æ­£ç¡®æ˜¾ç¤º `item.lastMessage`
- [x] ä¸å±•ç¤ºå®é™…å›¾ç‰‡ï¼Œåªå±•ç¤ºæ–‡å­—

### æˆªå›¾å¯¹æ¯”

**âŒ é”™è¯¯å®ç°ï¼ˆå¦‚æœç›´æ¥æ˜¾ç¤ºå›¾ç‰‡ï¼‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¤´åƒ]  ç”¨æˆ·å          12:30  â”‚
â”‚         [ğŸ“· å›¾ç‰‡ç¼©ç•¥å›¾]      (1) â”‚  â† é”™è¯¯ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… æ­£ç¡®å®ç°ï¼ˆæ˜¾ç¤ºæ–‡å­—ï¼‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¤´åƒ]  ç”¨æˆ·å          12:30  â”‚
â”‚         [å›¾ç‰‡]              (1) â”‚  â† æ­£ç¡®ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç»“è®º

âœ… **ç¬¬äºŒæ­¥å·²å®Œæˆï¼Œæ— éœ€ä¿®æ”¹ä»£ç **

åç«¯å’Œå‰ç«¯çš„å®ç°å·²ç»å®Œå…¨ç¬¦åˆè¦æ±‚ï¼š
1. åç«¯åœ¨ `sendMessage` æ—¶æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®æ­£ç¡®çš„é¢„è§ˆæ–‡æœ¬
2. å›¾ç‰‡æ¶ˆæ¯çš„é¢„è§ˆå›ºå®šä¸º `"[å›¾ç‰‡]"` å­—ç¬¦ä¸²
3. å‰ç«¯ç›´æ¥æ˜¾ç¤ºé¢„è§ˆæ–‡æœ¬ï¼Œä¸å°è¯•æ¸²æŸ“å®é™…å›¾ç‰‡
4. èŠå¤©åˆ—è¡¨ä¿æŒç®€æ´ï¼Œåªæ˜¾ç¤ºæ–‡å­—æç¤º

---

**çŠ¶æ€ï¼šéªŒè¯é€šè¿‡ âœ…**
**ä¸‹ä¸€æ­¥ï¼šå¯ä»¥è¿›è¡Œå®é™…æµ‹è¯•éªŒè¯**
